{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/parse-large-csv-file/","result":{"data":{"site":{"siteMetadata":{"title":"Kevin Ponce Blog","author":"Kevin Ponce"}},"markdownRemark":{"id":"238464ec-5c9b-5f3c-9e65-92e7c0dfc590","excerpt":"Sometimes is rails, you have to do an import from a large csv file.\nThe largest csv file I had to read had a million lines… As you could imagine, I ran into…","html":"<p>Sometimes is rails, you have to do an import from a large csv file.\nThe largest csv file I had to read had a million lines…</p>\n<p>As you could imagine, I ran into some memory issues on my worker.\nSo here is a some code that will allow you to read a large csv file.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string\">'csv'</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">csv_each</span></span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n  open<span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>csv<span class=\"token operator\">|</span>\n    count <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n      csv<span class=\"token punctuation\">.</span>each_line <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>line<span class=\"token operator\">|</span>\n        <span class=\"token variable\">@headers</span> <span class=\"token operator\">||</span><span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">{</span><span class=\"token operator\">|</span>col<span class=\"token operator\">|</span> col<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>join <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> count <span class=\"token operator\">!=</span> <span class=\"token number\">0</span>\n          d <span class=\"token operator\">=</span> build_hash<span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">,</span> <span class=\"token variable\">@headers</span><span class=\"token punctuation\">)</span>\n\n           <span class=\"token keyword\">yield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            id<span class=\"token punctuation\">:</span> d<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>downcase<span class=\"token punctuation\">,</span>\n            name<span class=\"token punctuation\">:</span> d<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">end</span>\n\n        count <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n      <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">build_hash</span></span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">)</span>\n  line<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>each_with_index<span class=\"token punctuation\">.</span>reduce<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>result<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span><span class=\"token operator\">|</span>\n    result<span class=\"token punctuation\">[</span>headers<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value\n\n    result\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\ncsv_each<span class=\"token punctuation\">(</span><span class=\"token string\">'example.csv'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>item<span class=\"token operator\">|</span>\n  <span class=\"token comment\"># TODO: do what ever you need with item object</span>\n<span class=\"token keyword\">end</span></code></pre></div>","frontmatter":{"title":"Parse Large CSV File","date":"January 22, 2020","description":"How to parse large csv file","author":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/parse-large-csv-file/","previous":{"fields":{"slug":"/rails-restricting-by-ip/"},"frontmatter":{"title":"Rails restricting by IP","tags":["ruby","ruby-on-rails"]}},"next":{"fields":{"slug":"/heroku-scale-dyno-from-ruby/"},"frontmatter":{"title":"Heroku Scale Dyno From Ruby","tags":["ruby","ruby-on-rails"]}}}}}